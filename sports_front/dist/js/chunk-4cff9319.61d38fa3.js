(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-4cff9319"],{"168a":function(t,e,a){"use strict";a.r(e);var s=function(){var t,e,a,s,r,o,i,l,n,c,p=this,d=p._self._c;return d("div",{staticClass:"exemption-application"},[d("el-alert",{staticStyle:{"margin-bottom":"20px"},attrs:{title:"如果您因特殊原因需要申请免测或重测，请在此提交申请。我们会尽快处理您的申请。",type:"info",closable:!1,"show-icon":""}}),d("el-button",{attrs:{type:"primary"},on:{click:p.showDialog}},[p._v("提交申请")]),p.applications.length?d("div",{staticClass:"application-history"},[d("h3",[p._v("申请记录")]),d("el-table",{staticStyle:{width:"100%"},attrs:{data:p.applications,border:""}},[d("el-table-column",{attrs:{prop:"applyTime",label:"申请时间",width:"180"},scopedSlots:p._u([{key:"default",fn:function(t){return[p._v(" "+p._s(p.formatDateTime(t.row.applyTime))+" ")]}}],null,!1,104975167)}),d("el-table-column",{attrs:{prop:"type",label:"申请类型",width:"100"},scopedSlots:p._u([{key:"default",fn:function(t){return[p._v(" "+p._s("EXEMPTION"===t.row.type?"免测":"重测")+" ")]}}],null,!1,3058082500)}),d("el-table-column",{attrs:{prop:"sportsItemName",label:"申请项目",width:"120"},scopedSlots:p._u([{key:"default",fn:function(t){return[p._v(" "+p._s(t.row.sportsItemName||"-")+" ")]}}],null,!1,927027323)}),d("el-table-column",{attrs:{prop:"reason",label:"申请原因","show-overflow-tooltip":""}}),d("el-table-column",{attrs:{label:"证明材料",width:"120",align:"center"},scopedSlots:p._u([{key:"default",fn:function(t){return[t.row.attachmentUrl?d("el-link",{attrs:{type:"primary"},on:{click:function(e){return p.previewAttachment(t.row.attachmentUrl)}}},[p._v(" 查看附件 ")]):d("span",[p._v("无")])]}}],null,!1,947837280)}),d("el-table-column",{attrs:{prop:"status",label:"状态",width:"100"},scopedSlots:p._u([{key:"default",fn:function(t){return[d("el-tag",{attrs:{type:p.getStatusType(t.row.status)}},[p._v(" "+p._s(p.getStatusText(t.row.status))+" ")])]}}],null,!1,2263538733)}),d("el-table-column",{attrs:{label:"审核意见","show-overflow-tooltip":""},scopedSlots:p._u([{key:"default",fn:function(t){return[t.row.adminReviewComment?d("div",[p._v(" "+p._s(t.row.adminReviewComment)+" ")]):t.row.teacherReviewComment?d("div",[p._v(" "+p._s(t.row.teacherReviewComment)+" ")]):d("span",[p._v("-")])]}}],null,!1,2518471398)}),d("el-table-column",{attrs:{label:"操作",width:"120",fixed:"right"},scopedSlots:p._u([{key:"default",fn:function(t){return["PENDING"===t.row.status?d("el-button",{attrs:{size:"mini",type:"danger"},on:{click:function(e){return p.handleDelete(t.row)}}},[p._v(" 撤销 ")]):d("el-button",{attrs:{size:"mini",type:"info"},on:{click:function(e){return p.handleDetail(t.row)}}},[p._v(" 查看 ")])]}}],null,!1,2423781565)})],1),d("div",{staticClass:"pagination-container"},[d("el-pagination",{attrs:{"current-page":p.currentPage,"page-sizes":[10,20,50,100],"page-size":p.pageSize,layout:"total, sizes, prev, pager, next, jumper",total:p.total},on:{"size-change":p.handleSizeChange,"current-change":p.handleCurrentChange,"update:currentPage":function(t){p.currentPage=t},"update:current-page":function(t){p.currentPage=t}}})],1)],1):p._e(),d("el-dialog",{attrs:{title:"提交申请",visible:p.dialogVisible,width:"50%"},on:{"update:visible":function(t){p.dialogVisible=t}}},[d("el-form",{ref:"form",attrs:{model:p.form,rules:p.rules,"label-width":"100px"}},[d("el-form-item",{attrs:{label:"申请类型",prop:"type"}},[d("el-radio-group",{on:{change:p.handleTypeChange},model:{value:p.form.type,callback:function(t){p.$set(p.form,"type",t)},expression:"form.type"}},[d("el-radio",{attrs:{label:"EXEMPTION"}},[p._v("免测申请")]),d("el-radio",{attrs:{label:"RETEST"}},[p._v("重测申请")])],1)],1),"RETEST"===p.form.type?d("el-form-item",{attrs:{label:"申请项目",prop:"sportsItemId"}},[d("el-select",{attrs:{placeholder:"请选择申请项目"},model:{value:p.form.sportsItemId,callback:function(t){p.$set(p.form,"sportsItemId",t)},expression:"form.sportsItemId"}},p._l(p.sportsItems,(function(t){return d("el-option",{key:t.id,attrs:{label:t.name,value:t.id}})})),1)],1):p._e(),d("el-form-item",{attrs:{label:"申请原因",prop:"reason"}},[d("el-input",{attrs:{type:"textarea",rows:4,placeholder:"EXEMPTION"===p.form.type?"请详细说明免测申请原因，并说明相关情况":"请说明重测原因"},model:{value:p.form.reason,callback:function(t){p.$set(p.form,"reason",t)},expression:"form.reason"}})],1),"EXEMPTION"===p.form.type?d("el-form-item",{attrs:{label:"证明材料",prop:"attachmentUrl",required:!0}},[d("el-upload",{staticClass:"upload-demo",attrs:{action:"/api/upload/file",headers:p.uploadHeaders,"on-success":p.handleUploadSuccess,"on-error":p.handleUploadError,"before-upload":p.beforeUpload,"on-remove":p.handleRemove,"file-list":p.fileList,limit:1}},[d("el-button",{attrs:{size:"small",type:"primary"}},[p._v("点击上传")]),d("div",{staticClass:"el-upload__tip",attrs:{slot:"tip"},slot:"tip"},[p._v(" 必须上传证明材料（医院证明等），只能上传jpg/png/pdf文件，且不超过10MB ")])],1)],1):p._e()],1),d("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[d("el-button",{on:{click:function(t){p.dialogVisible=!1}}},[p._v("取 消")]),d("el-button",{attrs:{type:"primary"},on:{click:p.submitForm}},[p._v("确 定")])],1)],1),d("el-dialog",{staticClass:"detail-dialog",attrs:{title:"申请详情",visible:p.detailDialogVisible,width:"600px"},on:{"update:visible":function(t){p.detailDialogVisible=t}}},[d("el-descriptions",{attrs:{column:1,border:""}},[d("el-descriptions-item",{attrs:{label:"申请类型"}},[p._v(" "+p._s("EXEMPTION"===(null===(t=p.currentRecord)||void 0===t?void 0:t.type)?"免测申请":"重测申请")+" ")]),d("el-descriptions-item",{attrs:{label:"申请时间"}},[p._v(" "+p._s(p.formatDateTime(null===(e=p.currentRecord)||void 0===e?void 0:e.applyTime))+" ")]),d("el-descriptions-item",{attrs:{label:"申请原因"}},[p._v(" "+p._s(null===(a=p.currentRecord)||void 0===a?void 0:a.reason)+" ")]),d("el-descriptions-item",{attrs:{label:"证明材料"}},[null!==(s=p.currentRecord)&&void 0!==s&&s.attachmentUrl?d("el-button",{attrs:{type:"text"},on:{click:function(t){return p.previewAttachment(p.currentRecord.attachmentUrl)}}},[p._v(" 查看附件 ")]):d("span",[p._v("无")])],1),d("el-descriptions-item",{attrs:{label:"状态"}},[d("el-tag",{attrs:{type:p.getStatusType(null===(r=p.currentRecord)||void 0===r?void 0:r.status)}},[p._v(" "+p._s(p.getStatusText(null===(o=p.currentRecord)||void 0===o?void 0:o.status))+" ")])],1),d("el-descriptions-item",{attrs:{label:"审核意见"}},[p._v(" "+p._s((null===(i=p.currentRecord)||void 0===i?void 0:i.adminReviewComment)||(null===(l=p.currentRecord)||void 0===l?void 0:l.teacherReviewComment)||"-")+" ")]),d("el-descriptions-item",{attrs:{label:"审核时间"}},[p._v(" "+p._s(null!==(n=p.currentRecord)&&void 0!==n&&n.adminReviewTime?p.formatDateTime(p.currentRecord.adminReviewTime):null!==(c=p.currentRecord)&&void 0!==c&&c.teacherReviewTime?p.formatDateTime(p.currentRecord.teacherReviewTime):"-")+" ")])],1)],1)],1)},r=[],o=(a("d9e2"),a("e9f5"),a("f665"),{name:"ExemptionApplication",data(){const t=(t,e,a)=>{"EXEMPTION"!==this.form.type||this.form.attachmentUrl?a():a(new Error("免测申请必须上传证明材料"))};return{dialogVisible:!1,form:{type:"EXEMPTION",reason:"",attachmentUrl:"",sportsItemId:null},rules:{type:[{required:!0,message:"请选择申请类型"}],reason:[{required:!0,message:"请填写申请原因",trigger:"blur"}],attachmentUrl:[{validator:t,trigger:"change"}],sportsItemId:[{required:!0,message:"请选择申请项目"}]},applications:[],fileList:[],uploadHeaders:{Authorization:"Bearer "+localStorage.getItem("token")},currentPage:1,pageSize:10,total:0,sportsItems:[],detailDialogVisible:!1,currentRecord:null}},methods:{handleTypeChange(t){this.form.attachmentUrl="",this.form.sportsItemId=null,this.fileList=[],"RETEST"===t?this.$set(this.rules,"sportsItemId",[{required:!0,message:"请选择申请项目",trigger:"change"}]):this.$delete(this.rules,"sportsItemId"),this.$nextTick(()=>{this.$refs.form.validateField("attachmentUrl")})},showDialog(){this.dialogVisible=!0,this.resetForm()},async submitForm(){try{var t;await this.$refs.form.validate();const e={...this.form,studentId:localStorage.getItem("userId"),type:this.form.type,sportsItemId:"RETEST"===this.form.type?this.form.sportsItemId:null,sportsItemName:"RETEST"===this.form.type?null===(t=this.sportsItems.find(t=>t.id===this.form.sportsItemId))||void 0===t?void 0:t.name:null},a="RETEST"===this.form.type?"/api/exemptions/student/submit-retest":"/api/exemptions/student/submit",s=await this.$http.post(a,e);200===s.data.code&&(this.$message.success("提交成功"),this.dialogVisible=!1,this.fetchApplications())}catch(e){console.error("提交失败:",e),this.$message.error("提交失败: "+e.message)}},resetForm(){this.$refs.form&&this.$refs.form.resetFields(),this.fileList=[],this.form.attachmentUrl=""},handleUploadSuccess(t){200===t.code?(this.form.attachmentUrl=t.data,this.$message.success("上传成功")):this.$message.error(t.message||"上传失败")},handleUploadError(t){console.error("上传失败:",t),this.$message.error("上传失败: "+(t.message||"未知错误"))},handleRemove(){this.form.attachmentUrl="",this.fileList=[]},beforeUpload(t){const e=["image/jpeg","image/png","application/pdf"].includes(t.type),a=t.size/1024/1024<10;return e?!!a||(this.$message.error("文件大小不能超过10MB!"),!1):(this.$message.error("只能上传JPG/PNG/PDF文件!"),!1)},async fetchApplications(){try{console.log("Fetching applications for user:",localStorage.getItem("userId"));const[t,e]=await Promise.all([this.$http.get("/api/exemptions/student/list",{params:{studentId:localStorage.getItem("userId"),page:this.currentPage-1,size:this.pageSize}}),this.$http.get("/api/exemptions/retest-applications/student/list",{params:{studentId:localStorage.getItem("userId"),page:this.currentPage-1,size:this.pageSize}})]);if(200===t.data.code&&200===e.data.code){const a=t.data.data.content||[],s=e.data.data.content||[];this.applications=[...a,...s].sort((t,e)=>new Date(e.applyTime)-new Date(t.applyTime)),this.total=t.data.data.totalElements+e.data.data.totalElements,console.log("Loaded applications:",this.applications),console.log("Total records:",this.total)}else this.$message.error("获取申请记录失败")}catch(t){console.error("获取申请记录失败:",t),this.$message.error("获取申请记录失败: "+t.message)}},getStatusType(t){const e={PENDING:"warning",APPROVED:"success",REJECTED:"danger"};return e[t]||"info"},getStatusText(t){const e={PENDING:"待审核",APPROVED:"已通过",REJECTED:"已驳回"};return e[t]||t},formatDateTime(t){return t?new Date(t).toLocaleString():"-"},previewAttachment(t){t&&window.open(t,"_blank")},handleSizeChange(t){this.pageSize=t,this.fetchApplications()},handleCurrentChange(t){this.currentPage=t,this.fetchApplications()},async handleDelete(t){try{await this.$confirm("确认撤销该申请吗？","提示",{type:"warning"});const e=await this.$http.delete("/api/exemptions/student/"+t.id,{params:{studentId:localStorage.getItem("userId")}});200===e.data.code?(this.$message.success("撤销成功"),this.fetchApplications()):this.$message.error(e.data.message||"撤销失败")}catch(e){"cancel"!==e&&(console.error("撤销申请失败:",e),this.$message.error("撤销失败: "+e.message))}},handleDetail(t){this.currentRecord=t,this.detailDialogVisible=!0},async fetchSportsItems(){try{const t=await this.$http.get("/api/sports-items/student/list");200===t.data.code&&(this.sportsItems=t.data.data)}catch(t){console.error("获取体育项目列表失败:",t),this.$message.error("获取体育项目列表失败")}}},async created(){await this.fetchApplications(),await this.fetchSportsItems(),console.log("Component created, applications:",this.applications)}}),i=o,l=(a("c0d7"),a("2877")),n=Object(l["a"])(i,s,r,!1,null,"7bb87b70",null);e["default"]=n.exports},c0d7:function(t,e,a){"use strict";a("d0b4")},d0b4:function(t,e,a){}}]);
//# sourceMappingURL=chunk-4cff9319.61d38fa3.js.map